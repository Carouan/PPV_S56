# ü§ñ D√©ploiement professionnel GLO d‚Äôun Bot Discord sur Raspberry Pi

> **Projet‚ÄØ: Coalition FFJ (Femmes de Droit) ‚Äî Exemplarit√© DevOps GLO**\
> *Auteur(s)‚ÄØ: S√©bastien Baudoux & ChatGPT (co-cr√©ation, 2024-2025)*

---

## üóÇÔ∏è Table des mati√®res

1. [Introduction et contexte](#introduction-et-contexte)
2. [Pr√©requis techniques](#pr√©requis-techniques)
3. [Pr√©sentation de l‚Äôarchitecture cible](#pr√©sentation-de-larchitecture-cible)
4. [D√©ploiement initial du bot Discord](#d√©ploiement-initial-du-bot-discord)
5. [Installation et configuration de Gitea (Git auto-h√©berg√©)](#installation-et-configuration-de-gitea-git-auto-h√©berg√©)
6. [√Ä suivre‚Ä¶](#√†-suivre)

---

# 1. Introduction et contexte

üéØ **Objectif**‚ÄØ:\
Ce document vise √† guider, de fa√ßon exhaustive et pragmatique, le **d√©ploiement d‚Äôun bot Discord professionnel sur un Raspberry Pi**, en s‚Äôappuyant uniquement sur des solutions **GLO** (Gratuites, Libres, Open-source) pour maximiser la souverainet√© num√©rique, l‚Äôapprentissage, la reproductibilit√© et la r√©silience.

üî¨ **Contexte**‚ÄØ:

- **Projet concret**‚ÄØ: bot Discord pour la *Coalition FFJ*, utilis√© dans le cadre associatif *Femmes de Droit* (FDD).
- **Probl√®me initial**‚ÄØ: le bot √©tait h√©berg√© sur *Railway*, solution cloud performante mais payante et propri√©taire, avec des limites d‚Äôutilisation et un risque d‚Äôinterruption.
- **D√©marche**‚ÄØ: migrer vers un auto-h√©bergement *Raspberry Pi*, dans une logique de mont√©e en comp√©tences (CV, freelance), de ma√Ætrise des co√ªts, et d‚Äôexemplarit√© DevOps/GLO.

üö© **Enjeux & ambitions**‚ÄØ:

- Obtenir une stack ‚Äúproduction ready‚Äù : s√©curit√©, fiabilit√©, CI/CD, monitoring, rollback, documentation, tests, etc.
- √ätre r√©plicable par d‚Äôautres associations, ou scalable pour d‚Äôautres usages (bots, sites, outils‚Ä¶).
- Avoir un socle technique qui pourra √©voluer (multi-bots, multi-services, archi distribu√©e‚Ä¶).

---

# 2. Pr√©requis techniques

## ‚öôÔ∏è Mat√©riel

| üîß Mat√©riel      | Sp√©cifications minimales                             | Conseils                       |
| ---------------- | ---------------------------------------------------- | ------------------------------ |
| Raspberry Pi     | 3B+, 4 ou sup., 2‚ÄØGo RAM min. (4-8‚ÄØGo recommand√©)    | Bo√Ætier ventil√©, dissipateur   |
| Stockage         | MicroSD 16‚ÄØGo min (pr√©f√©rer SSD/USB ou SD A2 32‚ÄØGo+) | SD de qualit√©, backups         |
| Alimentation     | Officielle, 2.5A min, √©viter les chargeurs low cost  | V√©rifier les messages d‚Äôerreur |
| Connexion r√©seau | Ethernet recommand√© (Wi-Fi OK mais moins stable)     | IP fixe ou r√©servation DHCP    |

## üíª Logiciels et outils √† pr√©parer

| Logiciel/outil          | Version/conseil                                             |
| ----------------------- | ----------------------------------------------------------- |
| OS (Raspberry Pi)       | Raspberry Pi OS Lite (Bullseye/Bookworm), ou Debian minimal |
| Python                  | 3.9+ (id√©alement la derni√®re stable)                        |
| Docker & Docker Compose | Derni√®res versions ARM compatibles                          |
| Git                     | Derni√®re version stable                                     |
| Un √©diteur de texte     | nano, vim, VSCode, ou √©quivalent                            |

## üîë Pr√©requis compte & acc√®s

- **Compte Discord** ayant les droits n√©cessaires pour cr√©er et administrer un bot
- **Acc√®s administrateur** SSH au Raspberry Pi
- **Acc√®s Internet** pour installation, mises √† jour et r√©cup√©ration des d√©pendances

## üîê S√©curit√© minimale

- G√©n√©rer une paire de **cl√©s SSH** forte (ed25519 ou rsa 4096)
- Changer le mot de passe par d√©faut du Pi
- D√©sactiver l‚Äôutilisateur ‚Äúpi‚Äù si possible
- Mettre √† jour le syst√®me d√®s l‚Äôinstallation (`sudo apt update && sudo apt upgrade -y`)

---

# 3. Pr√©sentation de l‚Äôarchitecture cible

Voici un **aper√ßu de la stack finale**, sous forme de diagramme Mermaid¬†:

```mermaid
flowchart TD
    Dev[Poste Dev]
    Gitea[Gitea (Git auto-h√©berg√©)]
    RPI[Raspberry Pi<br>(Docker: bot_discord)]
    VPN[VPN / Acc√®s s√©curis√©]
    Monitor[Monitoring / Supervision]
    Dev -- Commit / Push --> Gitea
    Gitea -- Webhook / CI/CD --> RPI
    RPI -- Tunnels s√©curis√©s --> VPN
    RPI -- Export logs / metrics --> Monitor
```

### **Composants majeurs**\*\*

- **Bot Discord Python**‚ÄØ: code principal, modularis√©, configurable (env, secrets)
- **Docker**‚ÄØ: conteneurisation, portabilit√©, isolation
- **Git auto-h√©berg√© (Gitea recommand√©)**‚ÄØ: d√©p√¥t code, d√©clencheurs de CI/CD (via webhooks)
- **Pipeline CI/CD**‚ÄØ: d√©ploiement automatis√© sur le Pi
- **Surcouche s√©curit√©**‚ÄØ: SSH, VPN, UFW, gestion des secrets
- **Monitoring & logs**‚ÄØ: supervision, alertes, sant√© syst√®me
- **Administration & backups**‚ÄØ: sauvegardes, scripts de maintenance

---

# 4. D√©ploiement initial du bot Discord

## üì¶ **√âtape 1 ‚Äî Pr√©paration du Raspberry Pi**

1. **Flash & d√©marrage OS**

   - T√©l√©charger Raspberry Pi OS Lite : [https://www.raspberrypi.com/software/operating-systems/](https://www.raspberrypi.com/software/operating-systems/)
   - Utiliser **Raspberry Pi Imager** ou **balenaEtcher** pour flasher la microSD/SSD
   - Booter, configurer la locale, clavier, r√©seau, SSH activ√©

2. **S√©curisation imm√©diate**

   - Changer le mot de passe (`passwd`)
   - G√©n√©rer/installer votre cl√© SSH (`ssh-keygen -t ed25519`)
   - (Optionnel) D√©sactiver le login par mot de passe dans `/etc/ssh/sshd_config` (`PasswordAuthentication no`)
   - Mettre √† jour le syst√®me (`sudo apt update && sudo apt upgrade -y`)

3. **Installer Python, Git et outils de base**

   ```bash
   sudo apt install -y python3 python3-pip git
   ```

## üê≥ **√âtape 2 ‚Äî Installation de Docker**

```bash
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER
# Se d√©connecter/reconnecter pour appliquer le groupe
```

**V√©rifier Docker**

```bash
docker run hello-world
```

Installer Docker Compose (si besoin)‚ÄØ:

```bash
sudo apt install -y docker-compose
```

*(ou version officielle si besoin de la derni√®re version ARM)*

## üìÇ **√âtape 3 ‚Äî Pr√©parer le code du bot Discord**

1. **Cr√©er ou cloner le d√©p√¥t (recommand√©‚ÄØ: Gitea auto-h√©berg√©)**

   ```bash
   git clone <url-depot-gitea-ou-github>
   cd <dossier-bot>
   ```

2. **Configurer le bot**

   - Copier le `.env.example` ‚Üí `.env` et renseigner‚ÄØ:
     ```
     DISCORD_TOKEN=xxxxxxxxx
     EMAIL_ADDRESS=xxx@xxx
     EMAIL_PASSWORD=xxxxxx
     ...
     ```

3. **Premier test en local (hors Docker)**

   ```bash
   python3 -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   python bot/core.py
   ```

   - V√©rifier que le bot appara√Æt en ligne sur Discord.
   - Corriger les √©ventuelles erreurs de d√©pendances/module.

## üêã **√âtape 4 ‚Äî Dockerisation du bot**

1. \*\*V√©rifier/Adapter le \*\*\`\`

   Exemple typique‚ÄØ:

   ```Dockerfile
   FROM python:3.11-slim
   WORKDIR /app
   COPY requirements.txt .
   RUN pip install --no-cache-dir -r requirements.txt
   COPY . .
   CMD ["python", "bot/core.py"]
   ```

2. **Construire et lancer le conteneur localement**

   ```bash
   docker build -t botdiscord .
   docker run --env-file .env botdiscord
   ```

   - V√©rifier que le bot fonctionne bien en conteneur.

3. \*\*(Optionnel) Cr√©er un \*\*\`\` Pour automatiser la base :

   ```yaml
   version: '3'
   services:
     botdiscord:
       build: .
       env_file: .env
       restart: unless-stopped
   ```

   ```bash
   docker compose up -d
   ```

---

## ‚úÖ **Contr√¥les post-install**

- Le bot s‚Äôaffiche bien comme ‚Äúen ligne‚Äù sur Discord ?
- Les logs dans Docker (`docker logs <container>`) sont propres ?
- Les variables d‚Äôenvironnement sont bien prises en compte ?
- La machine est √† jour et le port SSH n‚Äôest pas ouvert sur Internet ?

---

# 5. Installation et configuration de Gitea (Git auto-h√©berg√©)

## üéØ **Objectif**

Mettre en place un serveur **Gitea** sur le Raspberry Pi pour l‚Äôh√©bergement Git, le contr√¥le de version et l‚Äôautomatisation du d√©ploiement (webhooks/CI).

## üêß **√âtape 1 ‚Äî Installation de Gitea sur Raspberry Pi**

### 1. Installation via Docker (m√©thode recommand√©e GLO)

Cr√©e un dossier d√©di√© pour la persistance‚ÄØ:

```bash
mkdir -p ~/gitea/{data,config}
cd ~/gitea
```

Cr√©er un fichier `docker-compose.yml`‚ÄØ:

```yaml
version: "3"
services:
  gitea:
    image: gitea/gitea:latest
    container_name: gitea
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__database__DB_TYPE=sqlite3 # ou postgres/mysql si tu pr√©f√®res
      - GITEA__database__PATH=/data/gitea/gitea.db
    restart: always
    volumes:
      - ./data:/data
      - ./config:/etc/gitea
    ports:
      - "3000:3000"   # Web UI
      - "222:22"      # SSH Git
```

Lancer Gitea‚ÄØ:

```bash
docker compose up -d
```

Apr√®s quelques secondes, acc√®de √† l‚Äôinterface web via‚ÄØ:\
`http://<ip-pi>:3000`

---

### 2. Configuration initiale

- Cr√©ation du compte admin Gitea (nom, mail, mot de passe fort)
- Choix du mode de base de donn√©es (SQLite = simple, Postgres = robuste)
- R√©glages principaux‚ÄØ: nom du serveur, port, r√©pertoires, activation des SSH keys

---

### 3. S√©curisation de Gitea

- Change le mot de passe admin
- D√©sactive l‚Äôinscription libre si usage priv√©
- Autorise uniquement les connexions SSH avec cl√© (pas de mot de passe)
- Mets √† jour r√©guli√®rement l‚Äôimage Docker de Gitea
- Sauvegarde les dossiers `data/` et `config/` !

---

### 4. Premier push/test

1. Cr√©e un d√©p√¥t (repo) ‚Äúbot-discord-ffj‚Äù sur Gitea
2. Clone ce d√©p√¥t sur ton PC ou directement sur le Pi‚ÄØ:
   ```bash
   git clone ssh://gitea@<ip-pi>:222/bot-discord-ffj.git
   cd bot-discord-ffj
   # Ajoute le code du bot, commit, puis push !
   git add .
   git commit -m "Initial commit"
   git push origin main
   ```

---

### 5. Int√©gration future‚ÄØ: Webhooks, pipeline CI/CD (voir section suivante)

Gitea permet de d√©clencher des scripts automatiques √† chaque push via les webhooks (√† configurer dans les settings du d√©p√¥t). C‚Äôest la cl√© pour le d√©ploiement automatis√© sur le Raspberry Pi !

---

## üö¶ **Pr√™t pour la suite : Pipeline CI/CD et automatisation compl√®te !**

---

# 6. Pipeline CI/CD et automatisation du d√©ploiement

---

### üö¶ **Objectif**

Mettre en place une cha√Æne d‚Äôautomatisation qui‚ÄØ:

- D√©clenche le build/test/d√©ploiement du bot d√®s qu‚Äôun commit est ‚Äúpush‚Äù sur le d√©p√¥t Gitea (webhook).
- R√©duit au minimum les interventions manuelles pour mettre en production.
- Permet le rollback rapide et s√©curis√© en cas d‚Äôerreur.
- S‚Äôappuie uniquement sur des outils **GLO**‚ÄØ: scripts bash, Gitea, (optionnel‚ÄØ: Woodpecker CI, Drone, Forgejo Actions‚Ä¶).

---

### 6.1 **Concept g√©n√©ral de la CI/CD ‚Äúself-hosted‚Äù**

1. **Commit & push sur Gitea**\
   ‚Üí webhook d√©clencheur sur le Pi

2. **Script ‚Äúpost-receive‚Äù** sur le Pi (ou runner CI)

   - R√©cup√®re les derni√®res sources
   - Arr√™te le conteneur existant
   - Reconstruit l‚Äôimage Docker
   - Relance le conteneur
   - (Log toute la proc√©dure)

3. **Notifications / Alertes**

   - Succ√®s ou erreur de build/d√©ploiement (par mail, Discord, ou log centralis√©)

---

### 6.2 **Mise en place d‚Äôun pipeline basique par Webhook Gitea**

#### **A. Activer les webhooks sur Gitea**

- Aller sur la page du d√©p√¥t ‚Üí Settings ‚Üí Webhooks ‚Üí Add Webhook
- Renseigner‚ÄØ:
  - **URL** du serveur cible (Raspberry Pi), ex‚ÄØ:\
    `http://<IP-Pi>:8888/git-webhook`
  - √âv√©nements‚ÄØ: *Push events* (optionnel‚ÄØ: tag, release, PR, etc.)

---

#### **B. Mettre en place un ‚ÄúGit Webhook Receiver‚Äù sur le Pi**

Plusieurs choix‚ÄØ:

- **Script Bash custom** simple (pour usage minimaliste et reproductible)
- **Serveur Python (FastAPI/Flask) l√©ger**
- **Web service d√©di√© (ex‚ÄØ: Gitea Actions, Woodpecker, Forgejo Actions‚Ä¶)**

##### **Exemple minimaliste : mini serveur Flask recevant le webhook**

```python
# webhook_receiver.py
from flask import Flask, request
import subprocess

app = Flask(__name__)

@app.route('/git-webhook', methods=['POST'])
def handle_webhook():
    # Optionnel‚ÄØ: v√©rifier la signature du webhook pour s√©curit√©
    subprocess.Popen(["/home/pi/scripts/deploy_bot.sh"])
    return 'OK', 200

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8888)
```

- √Ä lancer en t√¢che de fond ou via systemd.

##### **Exemple de script de d√©ploiement d√©clench√© par le webhook**

```bash
#!/bin/bash
set -e

cd /home/pi/bot-discord-ffj/
git pull origin main

docker compose down || true
docker compose build
docker compose up -d

# Logging (optionnel)
date >> /home/pi/deploy.log
echo "D√©ploiement OK" >> /home/pi/deploy.log
```

- √Ä adapter selon l‚Äôemplacement du code et le nom du repo.
- **Permission d‚Äôex√©cution** : `chmod +x /home/pi/scripts/deploy_bot.sh`
- Ce script peut aussi envoyer une notif en cas d‚Äô√©chec (`mail`, Discord webhook‚Ä¶)

---

#### **C. S√©curisation du webhook**

- Restreindre les IPs autoris√©es √† acc√©der au port 8888 (UFW/iptables)
- (Recommand√©) Activer la **v√©rification de la signature HMAC** du webhook Gitea (secret partag√©)

---

#### **D. Alternatives GLO plus √©volu√©es (optionnelles)**

- **Woodpecker CI** ([site officiel](https://woodpecker-ci.org/))‚ÄØ: pipeline YAML, runners ARM, int√©gration facile avec Gitea
- **Forgejo Actions / Drone CI** : pipelines natifs Gitea/Forgejo

*Exemple de pipeline Woodpecker (yaml simplifi√©)*

```yaml
pipeline:
  build:
    image: python:3.11-slim
    commands:
      - pip install -r requirements.txt
      - pytest
      - docker build -t botdiscord .
      - docker compose up -d
```

- N√©cessite installation de Woodpecker serveur & agent sur le Pi.
- Permet √©tapes de tests, build, d√©ploiement, rollback, notifications, logs d√©taill√©s‚Ä¶

---

### 6.3 **Rollback et fiabilisation**

- **Revenir rapidement** √† une version pr√©c√©dente‚ÄØ:
  - Garder les anciennes images Docker (`docker images`)
  - Utiliser les tags Git pour versionner
  - Ajouter un script ‚Äúrollback.sh‚Äù qui relance l‚Äôancienne image en cas d‚Äô√©chec du build

---

### 6.4 **Surveillance & logs du pipeline**

- Stocker les logs de build/d√©ploiement (`deploy.log`)
- (Optionnel) Pousser les logs vers Grafana/Loki, ou les r√©sumer sur Discord par webhook

---

### 6.5 **Checklist d√©ploiement automatis√©**

-

---

# 7. Monitoring, supervision et s√©curit√© avanc√©e

(√Ä compl√©ter dans la prochaine √©tape‚ÄØ!)

